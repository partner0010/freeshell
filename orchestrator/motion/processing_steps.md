# 모션 처리 파이프라인 단계

## 전체 흐름

```
1. 이미지 입력
   ↓
2. 프롬프트 분석
   ↓
3. 모션 레벨 결정
   ├─ 기본: 사전 정의 모션
   ├─ 향상: 프롬프트 기반 선택
   ├─ 고급: AI 모션 생성
   └─ 실패: 규칙 기반 자동 적용
   ↓
4. 모션 데이터 생성
   ↓
5. FFmpeg 필터 생성
   ↓
6. 영상 렌더링
   ↓
7. 결과 반환
```

## 단계별 상세

### Step 1: 이미지 입력 및 검증

**입력**: 이미지 파일 (JPG, PNG)
**검증**:
- 파일 존재 확인
- 이미지 형식 확인
- 크기 제한 확인

**출력**: 검증된 이미지 경로

### Step 2: 프롬프트 분석

**입력**: 모션 프롬프트 문자열
**처리**:
- 키워드 추출
- 모션 타입 식별
- 강도 파악

**출력**: 분석된 모션 요구사항

### Step 3: 모션 레벨 결정

#### 3.1 기본: 사전 정의 모션
- **조건**: 프롬프트 없음 또는 기본 요청
- **처리**: 템플릿에서 기본 모션 선택
- **시간**: < 0.1초

#### 3.2 향상: 프롬프트 기반 선택
- **조건**: 명확한 키워드 포함
- **처리**: 키워드 매칭으로 모션 선택
- **시간**: < 0.5초

#### 3.3 고급: AI 모션 생성
- **조건**: AI 사용 요청 + Orchestrator 사용 가능
- **처리**: AI Orchestrator 호출
- **시간**: 5-30초

#### 3.4 실패: 규칙 기반 자동 적용
- **조건**: AI 실패 또는 사용 불가
- **처리**: 향상 단계로 Fallback
- **시간**: < 0.5초

### Step 4: 모션 데이터 생성

**입력**: 선택된 모션 레벨
**처리**:
- MotionData 객체 생성
- 표현식 설정
- 모션 파라미터 설정

**출력**: MotionData 객체

### Step 5: FFmpeg 필터 생성

**입력**: MotionData
**처리**:
- 호흡 모션 필터 (스케일)
- 고개 모션 필터 (회전/이동)
- 눈 모션 필터 (깜빡임 - 제한적)

**출력**: FFmpeg 필터 문자열

### Step 6: 영상 렌더링

**입력**: 이미지 + FFmpeg 필터
**처리**:
- FFmpeg 명령 실행
- 영상 파일 생성

**출력**: MP4 파일 경로

### Step 7: 결과 반환

**출력**:
- 성공 여부
- 영상 파일 경로
- 사용된 모션 레벨
- 모션 데이터

## Fallback 전략

```
AI 생성 시도
  ↓ (실패)
프롬프트 기반 선택
  ↓ (실패)
기본 템플릿 사용
  ↓ (항상 성공)
결과 반환
```

## 에러 처리

1. **이미지 없음**: 즉시 실패 반환
2. **AI 실패**: 자동 Fallback
3. **FFmpeg 실패**: 에러 반환 (재시도 가능)
4. **모션 데이터 오류**: 기본 모션 사용
